# Logstash Pipeline for Trading System Logs
# Phase 4 Tier 3: Advanced Observability

input {
  # TCP input for Python logging handler
  tcp {
    port => 5000
    codec => json
    tags => ["trading-system", "tcp"]
  }
  
  # UDP input for high-throughput logging
  udp {
    port => 5000
    codec => json
    tags => ["trading-system", "udp"]
  }
  
  # File input for reading log files
  file {
    path => "/var/log/trading-system/*.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => multiline {
      pattern => "^%{TIMESTAMP_ISO8601}"
      negate => true
      what => "previous"
    }
    tags => ["trading-system", "file"]
  }
}

filter {
  # Parse JSON logs
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
    }
  }
  
  # Parse standard Python log format
  grok {
    match => {
      "message" => "%{TIMESTAMP_ISO8601:timestamp} - %{DATA:logger_name} - %{LOGLEVEL:log_level} - %{GREEDYDATA:log_message}"
    }
  }
  
  # Parse timestamp
  date {
    match => ["timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss,SSS"]
    target => "@timestamp"
  }
  
  # Extract trading-specific fields
  if "trade" in [log_message] {
    grok {
      match => {
        "log_message" => "(?:Trade|ORDER).*symbol[=:]%{WORD:symbol}.*(?:price|executed_price)[=:]%{NUMBER:price:float}.*(?:quantity|qty)[=:]%{NUMBER:quantity:int}"
      }
    }
    mutate {
      add_field => { "event_type" => "trade" }
    }
  }
  
  # Extract error information
  if [log_level] == "ERROR" or [log_level] == "CRITICAL" {
    mutate {
      add_field => { "event_type" => "error" }
      add_tag => ["error"]
    }
  }
  
  # Extract performance metrics
  if "performance" in [log_message] or "latency" in [log_message] {
    grok {
      match => {
        "log_message" => ".*latency[=:]%{NUMBER:latency_ms:float}"
      }
    }
    mutate {
      add_field => { "event_type" => "performance" }
    }
  }
  
  # Extract P&L information
  if "pnl" in [log_message] or "profit" in [log_message] {
    grok {
      match => {
        "log_message" => ".*(?:pnl|profit)[=:]%{NUMBER:pnl:float}"
      }
    }
    mutate {
      add_field => { "event_type" => "pnl" }
    }
  }
  
  # Add environment and system info
  mutate {
    add_field => {
      "environment" => "production"
      "application" => "trading-system"
      "version" => "4.0"
    }
  }
  
  # Remove unnecessary fields
  mutate {
    remove_field => ["message", "host", "path"]
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "trading-system-logs-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }
  
  # Output to stdout for debugging (disable in production)
  # stdout {
  #   codec => rubydebug
  # }
  
  # Alert on critical errors
  if [log_level] == "CRITICAL" {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "trading-system-alerts-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }
}
