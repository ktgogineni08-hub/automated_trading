openapi: 3.0.3
info:
  title: Trading System API
  description: |
    RESTful API for the Trading System - Algorithmic trading platform for Indian equity and F&O markets.

    ## Features
    - Real-time portfolio monitoring
    - Order management and execution
    - Strategy configuration
    - Risk metrics and analytics
    - Historical data access
    - Compliance and audit logs

    ## Authentication
    All API endpoints require authentication using JWT tokens.
    Include the token in the `Authorization` header as `Bearer <token>`.

    ## Rate Limiting
    - 100 requests per minute per API key
    - Burst limit: 20 requests per second

    ## Environments
    - Production: `https://api.trading-system.example.com`
    - Staging: `https://api-staging.trading-system.example.com`
    - Development: `http://localhost:5000`

  version: 1.0.0
  contact:
    name: Trading System Support
    email: support@trading-system.example.com
    url: https://trading-system.example.com/support
  license:
    name: Proprietary
    url: https://trading-system.example.com/license

servers:
  - url: https://api.trading-system.example.com/api/v1
    description: Production server
  - url: https://api-staging.trading-system.example.com/api/v1
    description: Staging server
  - url: http://localhost:5000/api/v1
    description: Development server

tags:
  - name: Authentication
    description: User authentication and token management
  - name: Portfolio
    description: Portfolio positions and holdings
  - name: Orders
    description: Order management and execution
  - name: Strategies
    description: Trading strategy configuration
  - name: Market Data
    description: Market data and quotes
  - name: Analytics
    description: Performance analytics and metrics
  - name: Risk
    description: Risk management and metrics
  - name: Compliance
    description: Compliance and audit logs
  - name: System
    description: System health and monitoring

paths:
  # ============================================================================
  # Authentication Endpoints
  # ============================================================================
  /auth/login:
    post:
      tags:
        - Authentication
      summary: User login
      description: Authenticate user and obtain JWT token
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  example: trader@example.com
                password:
                  type: string
                  format: password
                  example: SecurePassword123!
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                    description: JWT access token
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  refresh_token:
                    type: string
                    description: JWT refresh token
                  expires_in:
                    type: integer
                    description: Token expiration in seconds
                    example: 3600
                  token_type:
                    type: string
                    example: Bearer
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh access token
      description: Obtain new access token using refresh token
      operationId: refreshToken
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  expires_in:
                    type: integer
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  # ============================================================================
  # Portfolio Endpoints
  # ============================================================================
  /portfolio/positions:
    get:
      tags:
        - Portfolio
      summary: Get all positions
      description: Retrieve all open and closed positions
      operationId: getPositions
      security:
        - BearerAuth: []
      parameters:
        - name: status
          in: query
          description: Filter by position status
          schema:
            type: string
            enum: [open, closed, all]
            default: open
        - name: symbol
          in: query
          description: Filter by symbol
          schema:
            type: string
            example: RELIANCE
        - name: limit
          in: query
          description: Maximum number of results
          schema:
            type: integer
            default: 100
            maximum: 500
        - name: offset
          in: query
          description: Pagination offset
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Positions retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  positions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Position'
                  total:
                    type: integer
                    description: Total number of positions
                  offset:
                    type: integer
                  limit:
                    type: integer
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /portfolio/summary:
    get:
      tags:
        - Portfolio
      summary: Get portfolio summary
      description: Retrieve portfolio summary with P&L, value, and metrics
      operationId: getPortfolioSummary
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Portfolio summary retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PortfolioSummary'

  # ============================================================================
  # Orders Endpoints
  # ============================================================================
  /orders:
    get:
      tags:
        - Orders
      summary: Get order history
      description: Retrieve all orders with optional filtering
      operationId: getOrders
      security:
        - BearerAuth: []
      parameters:
        - name: status
          in: query
          description: Filter by order status
          schema:
            type: string
            enum: [pending, executed, cancelled, rejected, all]
        - name: start_date
          in: query
          description: Start date (ISO 8601)
          schema:
            type: string
            format: date-time
        - name: end_date
          in: query
          description: End date (ISO 8601)
          schema:
            type: string
            format: date-time
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
      responses:
        '200':
          description: Orders retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  orders:
                    type: array
                    items:
                      $ref: '#/components/schemas/Order'
                  total:
                    type: integer

    post:
      tags:
        - Orders
      summary: Place new order
      description: Place a new buy or sell order
      operationId: placeOrder
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderRequest'
      responses:
        '201':
          description: Order placed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Order rejected by risk checks
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /orders/{order_id}:
    get:
      tags:
        - Orders
      summary: Get order details
      description: Retrieve details of a specific order
      operationId: getOrder
      security:
        - BearerAuth: []
      parameters:
        - name: order_id
          in: path
          required: true
          description: Order ID
          schema:
            type: string
      responses:
        '200':
          description: Order details retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
        '404':
          $ref: '#/components/responses/NotFoundError'

    delete:
      tags:
        - Orders
      summary: Cancel order
      description: Cancel a pending order
      operationId: cancelOrder
      security:
        - BearerAuth: []
      parameters:
        - name: order_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Order cancelled successfully
        '400':
          description: Order cannot be cancelled
        '404':
          $ref: '#/components/responses/NotFoundError'

  # ============================================================================
  # Strategies Endpoints
  # ============================================================================
  /strategies:
    get:
      tags:
        - Strategies
      summary: List all strategies
      description: Get list of all available trading strategies
      operationId: getStrategies
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Strategies retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  strategies:
                    type: array
                    items:
                      $ref: '#/components/schemas/Strategy'

  /strategies/{strategy_id}/config:
    get:
      tags:
        - Strategies
      summary: Get strategy configuration
      description: Retrieve configuration for a specific strategy
      operationId: getStrategyConfig
      security:
        - BearerAuth: []
      parameters:
        - name: strategy_id
          in: path
          required: true
          schema:
            type: string
            example: moving_average
      responses:
        '200':
          description: Configuration retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StrategyConfig'

    put:
      tags:
        - Strategies
      summary: Update strategy configuration
      description: Update parameters for a strategy
      operationId: updateStrategyConfig
      security:
        - BearerAuth: []
      parameters:
        - name: strategy_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StrategyConfig'
      responses:
        '200':
          description: Configuration updated successfully
        '400':
          $ref: '#/components/responses/BadRequestError'

  # ============================================================================
  # Market Data Endpoints
  # ============================================================================
  /market/quote:
    get:
      tags:
        - Market Data
      summary: Get real-time quotes
      description: Retrieve real-time quotes for one or more symbols
      operationId: getQuotes
      security:
        - BearerAuth: []
      parameters:
        - name: symbols
          in: query
          required: true
          description: Comma-separated list of symbols
          schema:
            type: string
            example: RELIANCE,INFY,TCS
      responses:
        '200':
          description: Quotes retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  quotes:
                    type: array
                    items:
                      $ref: '#/components/schemas/Quote'

  /market/historical:
    get:
      tags:
        - Market Data
      summary: Get historical data
      description: Retrieve historical OHLCV data
      operationId: getHistoricalData
      security:
        - BearerAuth: []
      parameters:
        - name: symbol
          in: query
          required: true
          schema:
            type: string
        - name: interval
          in: query
          required: true
          schema:
            type: string
            enum: [1m, 5m, 15m, 1h, 1d]
        - name: start_date
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: end_date
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Historical data retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  symbol:
                    type: string
                  interval:
                    type: string
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/OHLCV'

  # ============================================================================
  # Analytics Endpoints
  # ============================================================================
  /analytics/performance:
    get:
      tags:
        - Analytics
      summary: Get performance metrics
      description: Retrieve portfolio performance metrics
      operationId: getPerformanceMetrics
      security:
        - BearerAuth: []
      parameters:
        - name: period
          in: query
          schema:
            type: string
            enum: [1d, 1w, 1m, 3m, 6m, 1y, all]
            default: 1m
      responses:
        '200':
          description: Performance metrics retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PerformanceMetrics'

  /analytics/trades:
    get:
      tags:
        - Analytics
      summary: Get trade analytics
      description: Retrieve analytics for executed trades
      operationId: getTradeAnalytics
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Trade analytics retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TradeAnalytics'

  # ============================================================================
  # Risk Endpoints
  # ============================================================================
  /risk/metrics:
    get:
      tags:
        - Risk
      summary: Get risk metrics
      description: Retrieve current risk metrics including VaR, exposure, etc.
      operationId: getRiskMetrics
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Risk metrics retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RiskMetrics'

  /risk/limits:
    get:
      tags:
        - Risk
      summary: Get risk limits
      description: Retrieve configured risk limits
      operationId: getRiskLimits
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Risk limits retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RiskLimits'

  # ============================================================================
  # System Endpoints
  # ============================================================================
  /health:
    get:
      tags:
        - System
      summary: Health check
      description: Check system health status
      operationId: healthCheck
      responses:
        '200':
          description: System is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'
        '503':
          description: System is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'

  /metrics:
    get:
      tags:
        - System
      summary: Get system metrics
      description: Retrieve Prometheus-compatible metrics
      operationId: getMetrics
      responses:
        '200':
          description: Metrics retrieved
          content:
            text/plain:
              schema:
                type: string

# ============================================================================
# Components
# ============================================================================
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from /auth/login endpoint

  schemas:
    Position:
      type: object
      properties:
        symbol:
          type: string
          example: RELIANCE
        quantity:
          type: integer
          example: 100
        entry_price:
          type: number
          format: double
          example: 2450.50
        current_price:
          type: number
          format: double
          example: 2475.25
        pnl:
          type: number
          format: double
          description: Realized P&L
          example: 2475.0
        unrealized_pnl:
          type: number
          format: double
          description: Unrealized P&L
          example: 2475.0
        pnl_percentage:
          type: number
          format: double
          example: 1.01
        side:
          type: string
          enum: [LONG, SHORT]
        entry_time:
          type: string
          format: date-time
        stop_loss:
          type: number
          format: double
        take_profit:
          type: number
          format: double
        status:
          type: string
          enum: [open, closed]

    PortfolioSummary:
      type: object
      properties:
        total_value:
          type: number
          format: double
          example: 10500000.00
        cash_balance:
          type: number
          format: double
          example: 500000.00
        invested_value:
          type: number
          format: double
          example: 10000000.00
        total_pnl:
          type: number
          format: double
          example: 250000.00
        total_pnl_percentage:
          type: number
          format: double
          example: 2.50
        unrealized_pnl:
          type: number
          format: double
        realized_pnl:
          type: number
          format: double
        open_positions:
          type: integer
          example: 5
        total_positions:
          type: integer
          example: 15
        day_pnl:
          type: number
          format: double
        updated_at:
          type: string
          format: date-time

    Order:
      type: object
      properties:
        order_id:
          type: string
          example: ORD123456789
        symbol:
          type: string
          example: RELIANCE
        side:
          type: string
          enum: [BUY, SELL]
        quantity:
          type: integer
          example: 100
        order_type:
          type: string
          enum: [MARKET, LIMIT, STOP_LOSS, BRACKET]
        price:
          type: number
          format: double
          example: 2450.50
        stop_loss:
          type: number
          format: double
        take_profit:
          type: number
          format: double
        status:
          type: string
          enum: [PENDING, EXECUTED, CANCELLED, REJECTED, PARTIAL]
        filled_quantity:
          type: integer
        average_price:
          type: number
          format: double
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        strategy:
          type: string
          example: moving_average
        confidence:
          type: number
          format: double
          minimum: 0
          maximum: 1
          example: 0.82

    OrderRequest:
      type: object
      required:
        - symbol
        - side
        - quantity
        - order_type
      properties:
        symbol:
          type: string
          example: RELIANCE
        side:
          type: string
          enum: [BUY, SELL]
        quantity:
          type: integer
          minimum: 1
          example: 100
        order_type:
          type: string
          enum: [MARKET, LIMIT, STOP_LOSS, BRACKET]
        price:
          type: number
          format: double
          description: Required for LIMIT orders
        stop_loss:
          type: number
          format: double
        take_profit:
          type: number
          format: double
        strategy:
          type: string
          description: Strategy that generated this order

    Strategy:
      type: object
      properties:
        id:
          type: string
          example: moving_average
        name:
          type: string
          example: Moving Average Crossover
        description:
          type: string
        enabled:
          type: boolean
        performance:
          type: object
          properties:
            win_rate:
              type: number
              format: double
            total_trades:
              type: integer
            avg_return:
              type: number
              format: double

    StrategyConfig:
      type: object
      properties:
        strategy_id:
          type: string
        enabled:
          type: boolean
        parameters:
          type: object
          additionalProperties: true
          example:
            fast_period: 5
            slow_period: 15
            confidence_threshold: 0.7

    Quote:
      type: object
      properties:
        symbol:
          type: string
        last_price:
          type: number
          format: double
        bid:
          type: number
          format: double
        ask:
          type: number
          format: double
        volume:
          type: integer
        high:
          type: number
          format: double
        low:
          type: number
          format: double
        open:
          type: number
          format: double
        previous_close:
          type: number
          format: double
        change:
          type: number
          format: double
        change_percentage:
          type: number
          format: double
        timestamp:
          type: string
          format: date-time

    OHLCV:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        open:
          type: number
          format: double
        high:
          type: number
          format: double
        low:
          type: number
          format: double
        close:
          type: number
          format: double
        volume:
          type: integer

    PerformanceMetrics:
      type: object
      properties:
        period:
          type: string
        total_return:
          type: number
          format: double
        annualized_return:
          type: number
          format: double
        sharpe_ratio:
          type: number
          format: double
        sortino_ratio:
          type: number
          format: double
        max_drawdown:
          type: number
          format: double
        win_rate:
          type: number
          format: double
        total_trades:
          type: integer
        profitable_trades:
          type: integer
        avg_win:
          type: number
          format: double
        avg_loss:
          type: number
          format: double

    TradeAnalytics:
      type: object
      properties:
        total_trades:
          type: integer
        profitable_trades:
          type: integer
        losing_trades:
          type: integer
        win_rate:
          type: number
          format: double
        average_return:
          type: number
          format: double
        best_trade:
          type: number
          format: double
        worst_trade:
          type: number
          format: double
        average_hold_time:
          type: string
          description: Average holding period (e.g., "2h 30m")

    RiskMetrics:
      type: object
      properties:
        var_95:
          type: number
          format: double
          description: Value at Risk (95% confidence)
        var_99:
          type: number
          format: double
          description: Value at Risk (99% confidence)
        cvar:
          type: number
          format: double
          description: Conditional VaR (Expected Shortfall)
        portfolio_beta:
          type: number
          format: double
        volatility:
          type: number
          format: double
          description: Annualized volatility
        max_drawdown:
          type: number
          format: double
        current_exposure:
          type: number
          format: double
          description: Current market exposure as % of portfolio

    RiskLimits:
      type: object
      properties:
        max_position_size:
          type: number
          format: double
          example: 0.15
          description: Maximum position size as % of portfolio
        max_daily_loss:
          type: number
          format: double
          example: 0.02
          description: Maximum daily loss as % of portfolio
        max_open_positions:
          type: integer
          example: 20
        max_sector_exposure:
          type: integer
          example: 6
        max_trades_per_day:
          type: integer
          example: 150

    HealthStatus:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        timestamp:
          type: string
          format: date-time
        components:
          type: object
          properties:
            database:
              type: object
              properties:
                status:
                  type: string
                  enum: [up, down]
                latency_ms:
                  type: number
            redis:
              type: object
              properties:
                status:
                  type: string
                latency_ms:
                  type: number
            broker_api:
              type: object
              properties:
                status:
                  type: string
                latency_ms:
                  type: number

    Error:
      type: object
      properties:
        error:
          type: string
          description: Error code
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          description: Additional error details
        timestamp:
          type: string
          format: date-time

  responses:
    UnauthorizedError:
      description: Authentication failed or token invalid
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: UNAUTHORIZED
            message: Invalid or expired authentication token
            timestamp: "2025-11-01T10:30:00Z"

    NotFoundError:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: NOT_FOUND
            message: The requested resource was not found
            timestamp: "2025-11-01T10:30:00Z"

    BadRequestError:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: BAD_REQUEST
            message: Invalid request parameters
            details:
              field: quantity
              reason: Must be greater than 0
            timestamp: "2025-11-01T10:30:00Z"

    RateLimitError:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: RATE_LIMIT_EXCEEDED
            message: Too many requests. Please try again later.
            details:
              retry_after: 60
            timestamp: "2025-11-01T10:30:00Z"

security:
  - BearerAuth: []
