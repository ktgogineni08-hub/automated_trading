# Kubernetes ConfigMap for Trading System
# Phase 3 Tier 3: DevOps & Cloud Infrastructure

apiVersion: v1
kind: ConfigMap
metadata:
  name: trading-config
  namespace: trading
  labels:
    app: trading-system
data:
  # Application configuration
  trading_config.json: |
    {
      "system": {
        "mode": "production",
        "log_level": "INFO",
        "enable_metrics": true,
        "metrics_port": 9090
      },
      "trading": {
        "max_positions": 20,
        "position_size_pct": 0.05,
        "max_portfolio_value": 10000000,
        "enable_stop_loss": true,
        "stop_loss_pct": 0.02,
        "enable_take_profit": true,
        "take_profit_pct": 0.05
      },
      "risk_management": {
        "max_position_size_pct": 0.20,
        "max_drawdown_pct": 0.10,
        "var_confidence": 0.95,
        "enable_risk_parity": true
      },
      "ml": {
        "enable_ml_signals": true,
        "model_dir": "/app/models",
        "buy_threshold": 70,
        "sell_threshold": 30,
        "enable_anomaly_detection": true,
        "anomaly_threshold_std": 3.0
      },
      "data": {
        "realtime_enabled": true,
        "websocket_url": "wss://ws.zerodha.com/",
        "max_reconnect_attempts": 10,
        "reconnect_delay_seconds": 5
      },
      "monitoring": {
        "enable_prometheus": true,
        "enable_correlation_tracking": true,
        "health_check_interval": 30
      }
    }

  # Logging configuration
  logging.conf: |
    [loggers]
    keys=root,trading

    [handlers]
    keys=console,file

    [formatters]
    keys=detailed

    [logger_root]
    level=INFO
    handlers=console,file

    [logger_trading]
    level=INFO
    handlers=console,file
    qualname=trading_system
    propagate=0

    [handler_console]
    class=StreamHandler
    level=INFO
    formatter=detailed
    args=(sys.stdout,)

    [handler_file]
    class=handlers.RotatingFileHandler
    level=INFO
    formatter=detailed
    args=('/app/logs/trading.log', 'a', 10485760, 5)

    [formatter_detailed]
    format=%(asctime)s - %(name)s - %(levelname)s - %(message)s
    datefmt=%Y-%m-%d %H:%M:%S

  # Prometheus scrape config
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    scrape_configs:
      - job_name: 'trading-system'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - trading
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            target_label: __address__
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$2
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
